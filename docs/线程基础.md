## 1.线程安全  
### 1.1 何为线程安全？  
当多个线程访问一个类（对象或者方法）时，这个类始终都能表现出正确的行为，那么这个类（对象或者方法）就是线程安全的。也就是说，在多条线程访问的时候，我们的程序还能按照我们预期的行为去执行。  
### 1.2 深入理解线程安全  
"线程安全"真正来说并不是指线程的安全，而是指内存的安全。这个得从操作系统上去分析。  
目前主流操作系统都是多任务的，即多个进程同时运行。为了保证安全，每个进程只能访问分配给自己的内存空间，而不能访问别的进程的，这是由操作系统保障的。  
在每个进程的内存空间中都会有一块特殊的公共区域，通常称为堆（内存）。进程内的所有线程都可以访问到该区域，这就是造成问题的潜在原因。  
假设某个线程把数据处理到一半，觉得很累，就去休息了一会，回来准备接着处理，却发现数据已经被修改了，不是自己离开时的样子了。可能被其它线程修改了。  
类似于在小区绿化带上丢点钱，等会去看已经没有了，因为公共区域人来人往，你放的东西没有看管措施，一定是不安全的，堆（内存）的情况亦是如此。  
***所以线程安全指的是，在堆内存中的数据由于可以被任何线程访问到，在没有限制的情况下存在被意外修改的风险。***  
即堆内存空间在没有保护机制的情况下，对多线程来说是不安全的地方，因为你放进去的数据，可能被别的线程"破坏"。  
所以解决线程安全的问题就是一个取舍问题，不同的解决方案有不同的侧重点。  
#### 1.2.1 解决方案1: 私有的东西不应该让别人知道  
现实生活中，正常人都会把钱放抽屉保险柜里，不会让无关的人知道。因为这个毕竟是你的私人物品。
在程序中也是这样的，所以操作系统会为每个线程分配属于它自己的内存空间，通常称为栈内存，其它线程无权访问。这也是由操作系统保障的。  
如果一些数据只有某个线程会使用，其它线程不能操作也不需要操作，这些数据就可以放入线程的栈内存中。较为常见的就是局部变量。  
![](/images/ThreadSafeByLocalVariables.png)  
这里的变量sum，count，avg都是局部变量，它们都会被分配在线程栈内存中。  
假如现在A线程来执行这个方法，这些变量会在A的栈内存分配。与此同时，B线程也来执行这个方法，这些变量也会在B的栈内存中分配。  
也就是说这些局部变量会在每个线程的栈内存中都分配一份。由于线程的栈内存只能自己访问，所以栈内存中的变量只属于自己，其它线程根本就不知道。  
所以把自己的东西放到自己的私人地盘，是安全的，因为其他人无法知道。而且越隐私的地方越好。  
